# ç½‘å…³å¯¹æ¥è¯´æ˜

## âœ… å·²å®Œæˆçš„é…ç½®ä¿®å¤

### 1. ä¿®æ­£ä»£ç†ç«¯å£é…ç½®
**æ–‡ä»¶ï¼š** `vite.config.js`
```javascript
proxy: {
  '/api': {
    target: 'http://localhost:48080',  // ä¿®æ”¹ä¸ºç½‘å…³å®é™…ç«¯å£
    changeOrigin: true
  }
}
```

### 2. ä¿®æ­£Content-Type
**æ–‡ä»¶ï¼š** `src/utils/request.js`
```javascript
headers: {
  'Content-Type': 'application/octet-stream'  // ä¿®æ”¹ä¸ºåç«¯æœŸæœ›çš„ç±»å‹
}
```

### 3. ä¿®æ­£æ¥å£è·¯å¾„
**æ–‡ä»¶ï¼š** `src/api/request.js`
```javascript
const response = await http.post('/gateway/forward', requestBuffer)  // ä¿®æ”¹ä¸ºæ­£ç¡®è·¯å¾„
```

---

## ğŸ”„ ä»Mockåˆ‡æ¢åˆ°çœŸå®API

### å½“å‰çŠ¶æ€
æ‰€æœ‰é¡µé¢ç»„ä»¶ç›®å‰éƒ½åœ¨ä½¿ç”¨Mockæ•°æ®ï¼š
```javascript
// å½“å‰å¯¼å…¥ï¼ˆMockæ¨¡å¼ï¼‰
import { getNoticeList, createNotice } from '@/api/notice.mock.js'
```

### åˆ‡æ¢æ–¹æ³•
å°†å¯¼å…¥è·¯å¾„ä» `.mock.js` æ”¹ä¸º `.js` å³å¯ï¼š
```javascript
// åˆ‡æ¢åˆ°çœŸå®API
import { getNoticeList, createNotice } from '@/api/notice.js'
```

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

#### 1. ç”¨æˆ·ç›¸å…³
- `src/views/Login.vue` (ç¬¬3è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { login, register } from '@/api/user.mock.js'
  // ä¿®æ”¹å
  import { login, register } from '@/api/user.js'
  ```

- `src/views/profile/UserProfile.vue` (ç¬¬5è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { updateUserInfo } from '@/api/user.mock.js'
  // ä¿®æ”¹å
  import { updateUserInfo } from '@/api/user.js'
  ```

#### 2. å…¬å‘Šç›¸å…³
- `src/views/notice/NoticeList.vue` (ç¬¬5è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { getNoticeList } from '@/api/notice.mock.js'
  // ä¿®æ”¹å
  import { getNoticeList } from '@/api/notice.js'
  ```

- `src/views/notice/NoticeDetail.vue` (ç¬¬5è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { getNoticeList, confirmRead } from '@/api/notice.mock.js'
  // ä¿®æ”¹å
  import { getNoticeList, confirmRead } from '@/api/notice.js'
  ```

- `src/views/admin/NoticeManage.vue` (ç¬¬149è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { getNoticeList, createNotice, updateNotice } from '@/api/notice.mock.js'
  // ä¿®æ”¹å
  import { getNoticeList, createNotice, updateNotice } from '@/api/notice.js'
  ```

#### 3. æŠ•è¯‰ç›¸å…³
- `src/views/complaint/ComplaintList.vue` (ç¬¬158è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { getComplaintList } from '@/api/complaint.mock.js'
  // ä¿®æ”¹å
  import { getComplaintList } from '@/api/complaint.js'
  ```

- `src/views/complaint/CreateComplaint.vue` (ç¬¬5è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { createComplaint } from '@/api/complaint.mock.js'
  // ä¿®æ”¹å
  import { createComplaint } from '@/api/complaint.js'
  ```

- `src/views/admin/ComplaintManage.vue` (ç¬¬5è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { getComplaintList, updateComplaint } from '@/api/complaint.mock.js'
  // ä¿®æ”¹å
  import { getComplaintList, updateComplaint } from '@/api/complaint.js'
  ```

#### 4. å­¦ä¹ èµ„æ–™ç›¸å…³
- `src/views/study/StudyList.vue` (ç¬¬5è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { getStudyList, starStudy } from '@/api/study.mock.js'
  // ä¿®æ”¹å
  import { getStudyList, starStudy } from '@/api/study.js'
  ```

- `src/views/study/StudyDetail.vue` (ç¬¬5è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { getStudyList } from '@/api/study.mock.js'
  // ä¿®æ”¹å
  import { getStudyList } from '@/api/study.js'
  ```

- `src/views/admin/StudyManage.vue` (ç¬¬5è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { getStudyList, createStudy, updateStudy } from '@/api/study.mock.js'
  // ä¿®æ”¹å
  import { getStudyList, createStudy, updateStudy } from '@/api/study.js'
  ```

#### 5. äººå‘˜ä¿¡æ¯ç›¸å…³
- `src/views/people/PeopleList.vue` (ç¬¬5è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { getPeopleList } from '@/api/people.mock.js'
  // ä¿®æ”¹å
  import { getPeopleList } from '@/api/people.js'
  ```

- `src/views/people/PeopleDetail.vue` (ç¬¬5è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { getPeopleList } from '@/api/people.mock.js'
  // ä¿®æ”¹å
  import { getPeopleList } from '@/api/people.js'
  ```

- `src/views/admin/PeopleManage.vue` (ç¬¬5è¡Œ)
  ```javascript
  // ä¿®æ”¹å‰
  import { getPeopleList, createPeople, updatePeople } from '@/api/people.mock.js'
  // ä¿®æ”¹å
  import { getPeopleList, createPeople, updatePeople } from '@/api/people.js'
  ```

---

## ğŸš€ å¯åŠ¨å’Œæµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨åç«¯æœåŠ¡

#### å¯åŠ¨é¡ºåº
```bash
# 1. å¯åŠ¨Nacosï¼ˆå¦‚æœæœªå¯åŠ¨ï¼‰
# è®¿é—® http://localhost:8848/nacos
# ç”¨æˆ·å/å¯†ç : nacos/123456

# 2. å¯åŠ¨MySQLå’ŒRedisï¼ˆç¡®ä¿å·²è¿è¡Œï¼‰

# 3. å¯åŠ¨å„ä¸ªDubboæœåŠ¡æä¾›è€…
# - town-user-provider (ç«¯å£: 40001)
# - town-notice-provider
# - town-study-provider
# - town-question-provider
# - town-people-provider
# - town-update-provider
# - town-dao (ç«¯å£: 40002)

# 4. å¯åŠ¨TCPæœåŠ¡å™¨
# - town-consumer (ç«¯å£: 18023, 18026)

# 5. å¯åŠ¨HTTPç½‘å…³
# - town-http-gateway (ç«¯å£: 48080)
```

#### éªŒè¯ç½‘å…³æ˜¯å¦å¯åŠ¨
```bash
# æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
lsof -i :48080

# æˆ–ä½¿ç”¨curlæµ‹è¯•ï¼ˆä¼šè¿”å›é”™è¯¯ï¼Œä½†è¯´æ˜ç½‘å…³åœ¨è¿è¡Œï¼‰
curl -X POST http://localhost:48080/gateway/forward
```

### 2. å¯åŠ¨å‰ç«¯é¡¹ç›®

```bash
cd vue-village-system

# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœè¿˜æ²¡å®‰è£…ï¼‰
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

è®¿é—®ï¼šhttp://localhost:5173

### 3. æµ‹è¯•ç™»å½•åŠŸèƒ½

#### æµ‹è¯•è´¦å·
- **æ‘æ°‘è´¦å·**ï¼š13800138000 / 123456
- **æ‘å¹²éƒ¨è´¦å·**ï¼š13800138001 / 123456

#### æµ‹è¯•æ­¥éª¤
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾
3. åœ¨ç™»å½•é¡µé¢è¾“å…¥è´¦å·å¯†ç 
4. ç‚¹å‡»ç™»å½•
5. è§‚å¯Ÿç½‘ç»œè¯·æ±‚ï¼š
   - åº”è¯¥çœ‹åˆ° `gateway/forward` è¯·æ±‚
   - è¯·æ±‚ç±»å‹ï¼šPOST
   - Content-Type: application/octet-stream
   - å“åº”ä¹Ÿæ˜¯äºŒè¿›åˆ¶æ•°æ®

#### é¢„æœŸç»“æœ
- âœ… ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°é¦–é¡µ
- âœ… æ˜¾ç¤ºç”¨æˆ·åå’Œå¤´åƒ
- âœ… Tokenä¿å­˜åˆ°localStorage

#### å¯èƒ½çš„é”™è¯¯
1. **ç½‘ç»œé”™è¯¯**ï¼šæ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦éƒ½å·²å¯åŠ¨
2. **Tokenæ— æ•ˆ**ï¼šæ£€æŸ¥Redisæ˜¯å¦æ­£å¸¸è¿è¡Œ
3. **åè®®è§£æé”™è¯¯**ï¼šæ£€æŸ¥Protobufç‰ˆæœ¬æ˜¯å¦ä¸€è‡´

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹Protobufè¯·æ±‚å†…å®¹
åœ¨ `src/api/request.js` ä¸­æ·»åŠ è°ƒè¯•ä»£ç ï¼š
```javascript
// åœ¨å‘é€è¯·æ±‚å‰
console.log('å‘é€è¯·æ±‚:', {
  msgType: msgType,
  token: token,
  msgData: msgData
})

// åœ¨æ¥æ”¶å“åº”å
console.log('æ¥æ”¶å“åº”:', {
  errCode: responseMsg.errCode,
  msgType: responseMsg.msgType
})
```

### 2. æŸ¥çœ‹äºŒè¿›åˆ¶æ•°æ®
```javascript
// æŸ¥çœ‹è¯·æ±‚çš„äºŒè¿›åˆ¶æ•°æ®
console.log('è¯·æ±‚Buffer:', Array.from(requestBuffer))

// æŸ¥çœ‹å“åº”çš„äºŒè¿›åˆ¶æ•°æ®
console.log('å“åº”Buffer:', Array.from(new Uint8Array(response.data)))
```

### 3. åç«¯æ—¥å¿—
æŸ¥çœ‹åç«¯æ§åˆ¶å°è¾“å‡ºï¼Œå…³æ³¨ï¼š
- TCPè¿æ¥æ—¥å¿—
- TokenéªŒè¯æ—¥å¿—
- è¯·æ±‚å¤„ç†æ—¥å¿—
- é”™è¯¯æ—¥å¿—

---

## ğŸ“Š å®Œæ•´çš„è¯·æ±‚æµç¨‹

```
å‰ç«¯ (Vue)
  â†“
1. æ„å»ºProtobufæ¶ˆæ¯ (LoginReq)
  â†“
2. åŒ…è£…æˆRequestMsg (msgType + token + msg)
  â†“
3. åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶ (Uint8Array)
  â†“
4. HTTP POST /api/gateway/forward
  â†“
Viteä»£ç† (localhost:5173 â†’ localhost:48080)
  â†“
HTTPç½‘å…³ (town-http-gateway:48080)
  â†“
5. è½¬å‘åˆ°TCPæœåŠ¡å™¨ (Netty Client)
  â†“
TCPæœåŠ¡å™¨ (town-consumer:18023)
  â†“
6. è§£ç Protobuf (RequestMsg)
  â†“
7. éªŒè¯Token (TokenLoginInHandler)
  â†“
8. åˆ†å‘ä»»åŠ¡ (TaskDistributeInHandler)
  â†“
9. è°ƒç”¨DubboæœåŠ¡ (ServiceManager)
  â†“
ä¸šåŠ¡æœåŠ¡ (town-user-providerç­‰)
  â†“
10. è¿”å›ResponseMsg
  â†“
11. ç¼–ç ä¸ºProtobufäºŒè¿›åˆ¶
  â†“
TCP â†’ HTTPç½‘å…³ â†’ å‰ç«¯
  â†“
12. è§£ç ResponseMsg
  â†“
13. æ£€æŸ¥errCode
  â†“
14. è§£æä¸šåŠ¡å“åº” (LoginRsp)
  â†“
å®Œæˆ
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Tokenç®¡ç†
- Tokenæœ‰æ•ˆæœŸï¼š24å°æ—¶
- Tokenå­˜å‚¨ï¼šlocalStorage
- Tokenå¤±æ•ˆåä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ

### 2. æƒé™æ§åˆ¶
- æŸäº›æ“ä½œéœ€è¦æ‘å¹²éƒ¨æƒé™ï¼ˆuserPower = TUP_CGMï¼‰
- å‰ç«¯è·¯ç”±æœ‰æƒé™å®ˆå«
- åç«¯ä¹Ÿä¼šéªŒè¯æƒé™

### 3. é”™è¯¯å¤„ç†
å‰ç«¯å·²å®ç°å®Œæ•´çš„é”™è¯¯ç æ˜ å°„ï¼š
- `TRC_TOKEN_NOT_EXIST`: Tokenä¸å­˜åœ¨
- `TRC_TOKEN_INVALID`: Tokenæ— æ•ˆ
- `TRC_USER_POWER_NOT_ENOUGH`: æƒé™ä¸è¶³
- `TRC_DB_ERROR`: æ•°æ®åº“é”™è¯¯
- ç­‰ç­‰...

### 4. å¼€å‘å»ºè®®
- å¼€å‘é˜¶æ®µï¼šä½¿ç”¨Mockæ•°æ®ï¼Œå¿«é€Ÿè¿­ä»£
- è”è°ƒé˜¶æ®µï¼šåˆ‡æ¢åˆ°çœŸå®APIï¼Œæµ‹è¯•å®Œæ•´æµç¨‹
- ç”Ÿäº§ç¯å¢ƒï¼šç¡®ä¿æ‰€æœ‰æœåŠ¡éƒ½æ­£å¸¸è¿è¡Œ

---

## ğŸ“ å¿«é€Ÿåˆ‡æ¢è„šæœ¬

å¯ä»¥åˆ›å»ºä¸€ä¸ªè„šæœ¬æ¥å¿«é€Ÿåˆ‡æ¢Mock/çœŸå®APIï¼š

```bash
# switch-api.sh
#!/bin/bash

MODE=$1  # mock æˆ– real

if [ "$MODE" = "mock" ]; then
  find src/views -name "*.vue" -exec sed -i '' 's/@\/api\/\([^.]*\)\.js/@\/api\/\1.mock.js/g' {} \;
  echo "å·²åˆ‡æ¢åˆ°Mockæ¨¡å¼"
elif [ "$MODE" = "real" ]; then
  find src/views -name "*.vue" -exec sed -i '' 's/@\/api\/\([^.]*\)\.mock\.js/@\/api\/\1.js/g' {} \;
  echo "å·²åˆ‡æ¢åˆ°çœŸå®APIæ¨¡å¼"
else
  echo "ç”¨æ³•: ./switch-api.sh [mock|real]"
fi
```

ä½¿ç”¨æ–¹æ³•ï¼š
```bash
chmod +x switch-api.sh
./switch-api.sh mock   # åˆ‡æ¢åˆ°Mockæ¨¡å¼
./switch-api.sh real   # åˆ‡æ¢åˆ°çœŸå®APIæ¨¡å¼
```

---

## âœ… é…ç½®æ£€æŸ¥æ¸…å•

- [x] Viteä»£ç†ç«¯å£ï¼š48080
- [x] Content-Typeï¼šapplication/octet-stream
- [x] æ¥å£è·¯å¾„ï¼š/gateway/forward
- [x] Protobufæ–‡ä»¶å·²ç”Ÿæˆ
- [x] æ‰€æœ‰APIå‡½æ•°å·²å®ç°
- [ ] åç«¯æœåŠ¡å·²å¯åŠ¨
- [ ] åˆ‡æ¢åˆ°çœŸå®APIå¯¼å…¥
- [ ] æµ‹è¯•ç™»å½•åŠŸèƒ½
- [ ] æµ‹è¯•å„æ¨¡å—åŠŸèƒ½

---

ç°åœ¨å‰ç«¯é…ç½®å·²ç»å®Œæˆï¼Œå¯ä»¥å¯¹æ¥åç«¯ç½‘å…³äº†ï¼ğŸ‰
